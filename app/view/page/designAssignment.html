{% extends 'template/jhTemplateV3.html'%}
{% set appId = ctx.app.config.appId %}
{% set static = "/" + appId + "/public" %}

{% block css %}

<link type="text/css" href="<$ static $>/jsoneditor/jsoneditor.css" rel="stylesheet">
<script src="<$ static $>/jsoneditor/jsoneditor.js"></script>
{% endblock %}
{% block vue_template %}

<jh-layout-v3>
  <template slot="breadcrumbsTitle">
    【{{ title }}】的作业设计
    <span style="font-size: 1rem;" :class="{'d-block': isMobile}">(ID: {{ articleId }})</span>
  </template>
  
  <template slot="serverSearch">
    <v-row class="ma-0 align-center flex-none pa-0" :class="{'pa-2': !isMobile, 'pa-2': isMobile}" align="center" style="height: 100%;">
      <v-col class="d-flex" :class="{'pt-2': isMobile, 'pl-0': isMobile, 'pr-0': !isMobile}" style="justify-content: end">
        <v-btn color="success" dark class="elevation-0 mr-2" v-if="article && article.articleAssignmentPublishStatus !== 'publish'" @click="doAction('saveArticleAssignment', false)">保存</v-btn>
        <v-btn color="error" dark class="elevation-0 mr-2" v-if="article && article.articleAssignmentPublishStatus !== 'publish'" @click="doAction('saveArticleAssignment', 'publish')">提交</v-btn>
        <div v-else>
          <v-btn color="error" dark class="elevation-0 mr-2" disabled >已提交，不能修改</v-btn>
          <v-btn color="success" dark class="elevation-0 mr-2" @click="doAction('saveArticleAssignment', 'cancel')">撤销提交</v-btn>
        </div>
      </v-col>
    </v-row>
  </template>
  <template slot-scope="props" style="height: calc(100vh - 300px)">
    <tpl-form-design :form="articleAssignmentWithAnswer">
    </tpl-form-design>
  </template>
</jh-layout-v3>

{% endblock %}

{% block vue_body %}


{% include 'component/tpl/formItemListGenerator.html' %}
{% include 'component/tpl/tplFormDesign.html' %}
{% include 'component/vueJsonEditor.html' %}

<script type="module">
  new Vue({
    el: '#app',
    template: '#app-template',
    vuetify: new Vuetify(),
    data: () => ({
      formItemListPreviewDrawer: false,
      articleId: null,
      article: null,
      title: null,
      articleAssignmentWithAnswer: [],
      codemirrorOptions: {
        mode: 'application/json' ,
        theme: 'material-darker',
        indentUnit: 4,
        smartIndent: false,
        tabSize: 4,
        indentWithTabs: true,
      }
    }),
    computed: {
      isMobile() {
        return window.innerWidth < 600;
      },
      formItemList () {
        let list = []
        if (this.articleAssignmentWithAnswer) {
          list = _.cloneDeep(this.articleAssignmentWithAnswer);
          list.forEach(item => {
            // delete item.answerData;
            item.userData = {};
          })
        }
        return list;
      }
    },
    watch: {},
    async created() {
      const urlParams = new URLSearchParams(location.search);
      const articleId = urlParams.get('articleId');
      const title = urlParams.get('title');
      if (articleId) {
        this.articleId = articleId;
      }
      if (title) {
        this.title = title;
      }
      this.doAction('selectArticleAssignment', articleId);
    },
    mounted() {},
    methods: {
      async doAction(actionId, actionData) {
        switch (actionId) {
          case 'selectArticleAssignment':
            await this.selectArticleAssignment(actionData);
            break;
          case 'saveArticleAssignment':
            await this.saveArticleAssignment(actionData);
            break;
          default:
            console.error("[doAction] actionId not find", { actionId });
            break;
        }
      },
      // 获取作业详情
      async selectArticleAssignment(articleId) {
        const result = await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'assignmentDesign',
              actionId: 'selectArticleAssignment',
              where: { articleId: this.articleId }
            }
          }
        });

        if (result.data.appData.resultData.rows.length < 1) {
          window.vtoast.fail("文章不存在");
          return;
        }

        this.article = result.data.appData.resultData.rows[0];
        const articleAssignmentWithAnswer = JSON.parse(this.article.articleAssignmentWithAnswer || '[]');
        _.forEach(articleAssignmentWithAnswer, (item, index) => {
          if (!item.hasOwnProperty('upload')) {
            item.upload = [];
          }
          if (!item.hasOwnProperty('file')) {
            item.file = {};
          }
        })
        this.articleAssignmentWithAnswer = articleAssignmentWithAnswer;
      },

      // 保存作业
      async saveArticleAssignment (articleAssignmentPublishStatus = false) {
        if (!this.article) {
          window.vtoast.fail("文章不存在");
          return;
        }
        
        if (articleAssignmentPublishStatus === 'publish' && !await window.confirmDialog({ title: '提交后请勿再次修改保存', content: '确定提交吗？' })) {
          return
        }
        _.forEach(this.articleAssignmentWithAnswer, (item, index) => {
          item.file = {}
          _.forEach(item.upload, (type, i) => {
            console.log(type)
            item.file[type] = '';
          })
        })
        const articleAssignment = _.cloneDeep(this.articleAssignmentWithAnswer);
        articleAssignment.forEach(formItem => {
          formItem.answerData = {};
        })
        const actionData = {
            articleAssignmentWithAnswer: JSON.stringify(this.articleAssignmentWithAnswer),
            articleAssignment: JSON.stringify(articleAssignment),
          };
        if (articleAssignmentPublishStatus === 'publish') {
          actionData.articleAssignmentPublishStatus = articleAssignmentPublishStatus;
        }
        if (articleAssignmentPublishStatus === 'cancel') {
          actionData.articleAssignmentPublishStatus = null;
        }
        window.vtoast.loading("保存");
        await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'assignmentDesign',
              actionId: 'updateArticleAssignment',
              actionData,
              where: { articleId: this.articleId }
            }
          }
        });
        const msg = articleAssignmentPublishStatus === 'publish' ? '提交成功' : articleAssignmentPublishStatus === 'cancel' ? "撤销成功" : "保存成功";
        window.vtoast.success(msg);
        if (articleAssignmentPublishStatus) {
          this.article.articleAssignmentPublishStatus = articleAssignmentPublishStatus === 'publish' ? articleAssignmentPublishStatus : null;
        }
      },
    },
  })
</script>

<style scoped>
html {
  height: 100vh;
  overflow-y: hidden;
  min-width: 950px;
  overflow-x: scroll;
}
.v-list-item {
    height: unset;
}
</style>
{% endblock %}
